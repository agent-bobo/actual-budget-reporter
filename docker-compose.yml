version: '3.8'

services:
  actual-server:
    image: docker.io/actualbudget/actual-server:latest
    ports:
      - '5006:5006'
    volumes:
      - ./actual-data:/data
    restart: unless-stopped

  # 预算周报生成器 - 每周日运行一次
  budget-reporter:
    build: .
    # 不设置 restart，由 cron 触发运行
    environment:
      # Actual Budget 连接配置
      - ACTUAL_SERVER_URL=http://actual-server:5006
      - ACTUAL_PASSWORD=${ACTUAL_PASSWORD}
      - ACTUAL_BUDGET_ID=${ACTUAL_BUDGET_ID}
      
      # Gemini API (可选，用于生成自然语言摘要)
      - GOOGLE_GENERATIVE_AI_API_KEY=${GOOGLE_GENERATIVE_AI_API_KEY}
      
      # Discord Webhook (用于推送报告)
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
      
      # 月度预算配置 (可选，JSON格式，单位：分/cents)
      # 示例: {"餐饮": 50000, "交通": 20000} 表示餐饮预算$500，交通预算$200
      - MONTHLY_BUDGET=${MONTHLY_BUDGET:-{}}
    
    # 依赖 actual-server 先启动
    depends_on:
      - actual-server
    
    # 共享网络，确保能访问 actual-server
    networks:
      - default

networks:
  default:
    driver: bridge
